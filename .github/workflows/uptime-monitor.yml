name: Uptime Monitoring

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check API Health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://311.westwindsorforward.org/api/health || echo "000")
          
          if [ "$response" != "200" ]; then
            echo "::error::API health check failed with status: $response"
            exit 1
          fi
          
          echo "‚úÖ API health check passed (HTTP $response)"

      - name: Check Frontend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://311.westwindsorforward.org || echo "000")
          
          if [ "$response" != "200" ]; then
            echo "::error::Frontend health check failed with status: $response"
            exit 1
          fi
          
          echo "‚úÖ Frontend health check passed (HTTP $response)"

      - name: Auto-Restart Services (Self-Healing)
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ubuntu
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /home/ubuntu/WWF-Open-Source-311-Template
            echo "üîÑ Auto-healing triggered at $(date)"
            docker compose restart backend frontend
            sleep 30
            # Verify services are back up
            curl -sf http://localhost/api/health && echo "‚úÖ Backend recovered" || exit 1
        continue-on-error: true

      - name: Re-check After Restart
        if: failure()
        id: recheck
        run: |
          sleep 60
          response=$(curl -s -o /dev/null -w "%{http_code}" https://311.westwindsorforward.org/api/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "‚úÖ System self-healed successfully"
            echo "healed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Self-healing failed, escalating..."
            echo "healed=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify on Failure (Only if Self-Healing Failed)
        if: failure() && steps.recheck.outputs.healed != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Production Down - Self-Healing Failed',
              body: `## Production Health Check Failed\n\n**Time:** ${new Date().toISOString()}\n**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n‚ö†Ô∏è **Automatic restart was attempted but the system is still down.**\n\nPlease investigate immediately.`,
              labels: ['urgent', 'production']
            });
